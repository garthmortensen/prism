# Continuous Integration / Continuous Deployment pipeline
# Runs code quality checks on every push/PR, deploys on version tags
name: CI/CD

# When does this run?
# - Any push to main branch
# - Any tag starting with "v" (like v1.0.0)
# - Any pull request targeting main
on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

jobs:
  # ============================================================
  # LINT: Check code style and catch common mistakes
  # ============================================================
  lint:
    runs-on: ubuntu-latest # Use a fresh Ubuntu machine
    steps:
      - uses: actions/checkout@v4 # Download your code
      - uses: astral-sh/setup-uv@v4 # Install the uv package manager
      - run: uv sync --all-extras # Install Python dependencies (including dev tools)
      - run: uv run ruff check . # Check for code errors/style issues
      - run: uv run ruff format --check . # Verify code is properly formatted

  # ============================================================
  # TEST: Run the test suite to make sure nothing is broken
  # ============================================================
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Download your code
      - uses: astral-sh/setup-uv@v4 # Install the uv package manager
      - run: uv sync --all-extras # Install Python dependencies (including dev tools)
      - run: uv run pytest tests/ -v # Run all tests, verbose output

  # ============================================================
  # DBT: Verify dbt models compile without errors
  # ============================================================
  dbt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Download your code
      - uses: astral-sh/setup-uv@v4 # Install the uv package manager
      - run: uv sync --all-extras # Install Python dependencies
      - run: cd dbt && uv run dbt compile # Compile dbt models (no execution)

  # ============================================================
  # DEPLOY: Build container and push to GitHub Container Registry
  # Only runs on version tags (v*) AFTER lint/test/dbt pass
  # ============================================================
  deploy:
    if: startsWith(github.ref, 'refs/tags/v') # Only run for version tags
    needs: [lint, test, dbt] # Wait for all checks to pass first
    runs-on: ubuntu-latest
    permissions:
      contents: read # Can read repo contents
      packages: write # Can push to container registry
    steps:
      - uses: actions/checkout@v4 # Download your code

      # Build a container image from the Dockerfile
      - name: Build container
        run: podman build -t prism:${{ github.ref_name }} .

      # Login to GitHub's container registry so we can push images
      - name: Login to GitHub Container Registry
        run: podman login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}

      # Add the full registry path to the image name
      - name: Tag for registry
        run: podman tag prism:${{ github.ref_name }} ghcr.io/${{ github.repository }}:${{ github.ref_name }}

      # Upload the versioned image (e.g., ghcr.io/user/prism:v1.0.0)
      - name: Push to registry
        run: podman push ghcr.io/${{ github.repository }}:${{ github.ref_name }}

      # Also tag and push as "latest" for convenience
      - name: Tag and push as latest
        run: |
          podman tag prism:${{ github.ref_name }} ghcr.io/${{ github.repository }}:latest
          podman push ghcr.io/${{ github.repository }}:latest
